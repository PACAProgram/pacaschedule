<!DOCTYPE html>
<html>
<head>
  <title>Today's Lessons</title>
  <style>
    body { font-family: sans-serif; padding: 2rem; }
    table { width: 100%; border-collapse: collapse; }
    th, td { border: 1px solid #ccc; padding: 8px; }
    th { background: #f5f5f5; }
  </style>
</head>
<body>
  <h1>Today's Lessons (AEDT)</h1>
  <p><em>Powered by Cloudflare Worker</em></p>
  <table id="lessons-table">
    <thead>
      <tr><th>Title</th><th>Location</th><th>Start</th><th>End</th></tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>
    const ENDPOINT = "https://pacman.pacaprogram.workers.dev/";

    async function loadLessons() {
      const res = await fetch(ENDPOINT);
      const rawEvents = await res.json();

      const events = rawEvents.map(evt => {
        const start = parseUTC(evt.start);
        const end = parseUTC(evt.end);
        return {
          ...evt,
          start,
          end,
          aedtStart: toAEDT(start),
          aedtEnd: toAEDT(end),
        };
      });

      const today = new Intl.DateTimeFormat("en-AU", {
        timeZone: "Australia/Sydney",
        year: "numeric",
        month: "2-digit",
        day: "2-digit"
      }).format(new Date());

      const todaysEvents = events.filter(e => {
        const eDay = new Intl.DateTimeFormat("en-AU", {
          timeZone: "Australia/Sydney",
          year: "numeric",
          month: "2-digit",
          day: "2-digit"
        }).format(e.start);
        return eDay === today;
      });

      todaysEvents.sort((a, b) => a.location.localeCompare(b.location));
      renderLessons(todaysEvents);
    }

    function parseUTC(value) {
      const match = value.match(/^(\\d{4})(\\d{2})(\\d{2})T(\\d{2})(\\d{2})(\\d{2})Z$/);
      if (!match) return null;
      const [_, y, m, d, h, min, s] = match;
      return new Date(Date.UTC(+y, +m - 1, +d, +h, +min, +s));
    }

    function toAEDT(date) {
      return new Intl.DateTimeFormat("en-AU", {
        timeZone: "Australia/Sydney",
        weekday: "short",
        hour: "2-digit",
        minute: "2-digit",
        day: "numeric",
        month: "short",
        year: "numeric"
      }).format(date);
    }

    function renderLessons(events) {
      const tbody = document.querySelector(\"#lessons-table tbody\");
      tbody.innerHTML = events.length === 0
        ? '<tr><td colspan=\"4\">No lessons today.</td></tr>'
        : events.map(evt => `
            <tr>
              <td>${evt.summary}</td>
              <td>${evt.location}</td>
              <td>${evt.aedtStart}</td>
              <td>${evt.aedtEnd}</td>
            </tr>`).join('');
    }

    loadLessons();
  </script>
</body>
</html>
